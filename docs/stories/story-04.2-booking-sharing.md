# 用户故事 04.2: 预约分享与邀请

## 故事信息
- **故事ID**: 04.2
- **故事标题**: 预约分享与邀请
- **所属史诗**: 史诗04 - 社交协作
- **优先级**: 高
- **负责团队**: 社交团队 + 前端开发团队

## 故事描述

**作为** 一名已经预约了私教课程的用户
**我想要** 将这个预约分享给我的朋友，邀请他们加入，并一起分摊费用
**这样我可以** 降低我个人的课程成本，同时和朋友一起享受运动的乐趣

## 价值说明

### 核心价值
此功能直击私教课程"价格高"和用户"希望与朋友同乐"两大痛点。通过一个简单的分享动作，将一个单人决策过程，转变为一个社交协作过程，是盘活好友关系、激活私教课程消费的关键功能，能有效提升私教课程的订单量和平台的社交活跃度。

### 业务价值
- **提升私教订单量**: 费用分摊极大地降低了用户的决策门槛，能有效提升私教课程的购买转化率。
- **提高客单价**: 将原本1对1的私教课，转变为1对2，提升了单个时间段的课程价值。
- **病毒式用户增长**: 分享邀请是最高效、最低成本的拉新方式。被邀请的好友很可能成为平台的新用户。
- **强化社交属性**: "一起上课"是极强的社交场景，能有效增强用户之间的关系和他们对平台的粘性。

## 详细需求

### 功能需求
1.  **生成分享/邀请**:
    *   在私教课程"待支付"或"预约成功"的详情页，提供一个明显的"邀请好友，分摊费用"按钮。
    *   点击后，系统生成一个专属的邀请链接或小程序卡片。
    *   邀请信息中清晰地展示：课程信息（教练、时间、地点）、总费用、分摊后的费用（如"2人同行，每人仅需XXX元"）。
2.  **分享渠道**:
    *   支持直接分享给微信好友。
    *   支持生成可复制的链接，用于在其他渠道分享。
3.  **被邀请者视角**:
    *   好友点击邀请链接/卡片后，进入一个着陆页。
    *   页面清晰展示课程信息、发起人的信息（头像、昵称），以及自己需要支付的金额。
    *   提供"接受邀请"和"拒绝邀请"按钮。
4.  **接受邀请与支付**:
    *   好友点击"接受邀请"后，如果还不是平台用户，引导其快速注册。
    *   进入支付页面，支付自己需要分摊的那部分费用。
5.  **状态同步与管理**:
    *   **发起人视角**:
        *   可以看到邀请的状态，如"等待好友确认"、"好友已加入"。
        *   如果好友在规定时间内未接受，邀请自动失效。
        *   如果自己是"待支付"状态，需要等好友加入并支付后，自己再支付剩余部分，或系统自动扣款。
    *   **系统处理**:
        *   当所有参与者都支付成功后，系统最终确认整个预约。
        -   后台订单系统需要能处理这种"多人支付一单"的复杂订单结构。

### 非功能需求
-   **性能**: 邀请链接的生成和加载要快，<2秒。
-   **安全性**: 邀请链接需要有加密签名，防止被篡改。邀请有时效性（如24小时）。
-   **数据一致性**: 严格保证费用分摊计算的准确性，以及多人支付状态的同步一致性。

## 验收标准

### 功能验收标准
-   **AC1**: 用户可以成功生成一个私教课程的邀请链接/卡片。
-   **AC2**: 邀请信息中准确展示了分摊后的价格。
-   **AC3**: 被邀请的好友可以通过链接/卡片，看到邀请详情并接受邀请。
-   **AC4**: 好友接受邀请后，可以成功支付自己分摊的费用。
-   **AC5**: 所有参与者都支付成功后，原预约的发起人会收到"组队成功"的通知。

### 用户体验验收标准
-   **UX1**: 邀请按钮的位置明显，文案有吸引力。
-   **UX2**: 整个邀请和接受的流程清晰、简单，没有令人困惑的步骤。
-   **UX3**: 费用和状态的展示在每一步都清晰、透明。

### 业务目标验收标准
-   **BIZ1**: 超过30%的私教课程，是通过邀请好友共同完成的。
-   **BIZ2**: 通过此功能带来的新用户注册量，占总新用户注册量的10%以上。

## 依赖关系

### 技术依赖
-   好友系统 (Story 04.1)
-   支付与交易功能 (Epic 03)，特别是需要支持分摊支付的复杂逻辑
-   预约管理中心 (Story 02.4)
-   消息通知系统

### 业务依赖
-   已制定好私教课程是否允许1对2，以及相应的价格策略。
-   已定义好费用分摊的规则（如是否必须均分）。

### 外部依赖
-   微信分享API
-   支付网关

## 风险与缓解措施

### 主要风险
1.  **流程复杂导致用户流失**: 邀请、等待、多人支付的流程如果设计不当，任何一步都可能导致整个预约失败。
    -   **缓解措施**:
        *   极致地简化操作步骤，每一步都有清晰的指引和状态反馈。
        *   设置合理的等待和支付时限，并通过通知提醒用户。
        *   考虑提供"发起人先付全款，好友后续再支付给发起人"的模式作为备选，简化流程。
2.  **社交纠纷**: 好友接受邀请后反悔，或对费用有异议。
    -   **缓解措施**:
        *   在接受邀请前，让规则（如取消和退款政策）清晰、透明。
        *   提供灵活的取消和退款机制 (Story 02.6, 03.3)。
3.  **技术实现复杂性**: "多人支付一单"的订单和账务模型比较复杂，容易出错。
    -   **缓解措施**:
        *   进行充分的技术设计和评审。
        *   编写全面的测试用例，覆盖各种异常情况（如一人支付成功，另一人失败）。
        *   建立监控和对账机制。

## 成功指标

### 定量指标
-   **私教课程邀请率**: >30%
-   **邀请接受率**: >60%
-   **拉新转化率**: 每个成功邀请平均带来0.5个新用户

### 定性指标
-   **用户反馈**: 用户认为此功能"省钱"、"方便"、"和朋友一起玩更开心了"。

## 变更日志

| 日期 | 版本 | 描述 |
| :--- | :--- | :---------- |
|      | 1.0  | 初始版本创建，定义预约分享与邀请功能 |

## 相关链接

- [史诗04: 社交协作](../epics/epic-04-social-collaboration.md)
- [故事04.1: 好友系统](story-04.1-friend-system.md)
- [故事02.3: 私教预约流程](story-02.3-private-lesson-booking.md)
- [故事03.1: 微信支付集成](story-03.1-wechat-payment.md)

## 测试用例

### 关键测试场景

#### TC1: 完整分享邀请流程
1. 用户预约团课
2. 生成分享链接
3. 分享给微信好友
4. 好友点击链接查看
5. 好友确认参与并支付
6. 验证课程参与者更新

#### TC2: 多人同时邀请
1. 发起人邀请3个朋友
2. 朋友们同时查看邀请
3. 验证名额控制机制
4. 确保不超过课程容量
5. 验证费用分摊正确

#### TC3: 邀请过期处理
1. 生成有时效性的邀请链接
2. 等待邀请过期
3. 朋友尝试访问过期链接
4. 验证过期提示
5. 确认课程状态不受影响

#### TC4: 费用分摊边界测试
1. 创建有优惠的课程邀请
2. 多人参与不同分摊方式
3. 测试各种分摊计算情况
4. 验证支付金额正确
5. 确认退款分摊处理

#### TC5: 分享渠道兼容性
1. 测试微信内分享
2. 测试复制链接分享
3. 测试二维码分享
4. 验证不同渠道显示效果
5. 确保跨平台兼容性

## 技术实现要点

### 关键技术决策

#### 分享链接架构
```javascript
// 分享链接生成
const generateShareLink = (bookingId, userId) => {
  const shareCode = generateUniqueCode();
  const shareData = {
    booking_id: bookingId,
    sharer_id: userId,
    share_code: shareCode,
    expires_at: Date.now() + (24 * 60 * 60 * 1000), // 24小时
    max_participants: getBookingCapacity(bookingId),
    created_at: Date.now()
  };
  
  return `${DOMAIN}/share/${shareCode}`;
};
```

#### 费用分摊算法
```javascript
const calculateCostSplit = (totalAmount, participants, splitType) => {
  switch(splitType) {
    case 'equal':
      return participants.map(() => totalAmount / participants.length);
    case 'custom':
      return calculateCustomSplit(totalAmount, participants);
    case 'host_pays_extra':
      return calculateHostPaysExtra(totalAmount, participants);
    default:
      return participants.map(() => totalAmount / participants.length);
  }
};
```

#### 实时状态同步
```javascript
// WebSocket事件处理
const handleInviteResponse = (shareCode, userId, response) => {
  const invitation = getInvitation(shareCode);
  updateInvitationStatus(invitation.id, userId, response);
  
  // 通知发起人
  notifySharer(invitation.sharer_id, {
    type: 'invite_response',
    user: userId,
    response: response,
    remaining_slots: getRemainingSlots(invitation.booking_id)
  });
};
```

### 数据模型设计
```sql
booking_shares (
  id, booking_id, sharer_id, share_code,
  max_participants, expires_at, status,
  cost_split_type, created_at
)

share_invitations (
  id, share_id, invitee_id, status,
  amount_to_pay, responded_at, created_at
)
```

## 依赖和风险

### 技术依赖
- 微信分享API的稳定性
- 实时通知系统的可靠性
- 支付系统的分摊支持

### 主要风险
- **风险1**: 分享链接被恶意传播 - 缓解：访问频率限制，邀请人验证
- **风险2**: 费用分摊计算错误 - 缓解：多重验证，边界情况测试
- **风险3**: 微信分享政策变化 - 缓解：多渠道分享支持，备用方案

### 用户体验风险
- 复杂的费用分摊可能困扰用户
- 邀请过多可能造成社交压力
- 分享链接安全性担忧

## 相关链接

- [史诗04: 社交协作](../epics/epic-04-social-collaboration.md)
- [故事04.1: 好友系统](story-04.1-friend-system.md)
- [故事02.3: 私教预约流程](story-02.3-private-lesson-booking.md)
- [故事03.1: 微信支付集成](story-03.1-wechat-payment.md)

## 变更日志

| 日期 | 版本 | 描述 | 作者 |
| :--- | :------ | :---------- | :----- |
| 2024-12-27 | 1.0 | 初始版本创建，定义预约分享与邀请功能 | 姜尚 | 