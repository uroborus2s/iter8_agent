# 用户故事 03.1: 微信支付集成

## 故事信息
- **故事ID**: 03.1
- **故事标题**: 微信支付集成
- **所属史诗**: 史诗03 - 支付与交易
- **优先级**: 高
- **负责团队**: 后端开发团队 + 前端开发团队

## 故事描述

**作为** 一名在微信小程序内完成预约的用户
**我想要** 直接使用微信支付来完成付款
**这样我可以** 享受流畅、安全、无需跳出小程序的"原生"支付体验

## 价值说明

### 核心价值
微信支付是国民级的支付工具，在微信小程序生态内，提供无缝的微信支付体验是保障交易转化率的生命线。一个流畅、可靠的支付流程，能最大程度地减少用户在最后一步的流失，将用户的预约意愿顺利转化为实际收入。

### 业务价值
- **最大化支付转化率**: 提供用户最熟悉、最信任的支付方式，减少支付环节的流失，预计支付成功率可达98%以上。
- **提升用户体验**: 无需跳转其他App，在小程序内即可完成闭环交易，体验流畅、连贯。
- **简化财务对账**: 统一的支付渠道便于后期的财务管理和自动化对账。
- **利用微信生态**: 可以与微信的卡包、服务通知等功能结合，提供更丰富的后续服务。

## 详细需求

### 功能需求
1.  **发起支付**:
    *   在用户点击"立即支付"后，前端将订单信息（如订单号、金额）发送给后端服务。
    *   后端服务根据订单信息，与业务数据进行校验（如确认订单状态、金额是否正确）。
    *   后端调用微信支付的"统一下单"API，生成一个预支付交易单（Prepay ID）。
    *   后端将发起支付所需的参数（包括Prepay ID、签名等）安全地返回给前端。
2.  **调起支付**:
    *   小程序前端接收到支付参数后，调用微信小程序提供的 `wx.requestPayment` API。
    *   小程序客户端自动拉起微信支付的标准界面（输入密码或指纹/面容ID）。
3.  **处理支付结果**:
    *   **支付成功**:
        *   `wx.requestPayment` API会返回成功的回调。
        *   同时，微信支付服务器会异步地将支付结果通知到后端预设的回调URL。
        *   后端在收到异步通知后，必须进行签名校验，确认是合法的微信回调。
        *   校验成功后，后端更新订单状态为"已支付"，并记录相关支付信息（如微信支付订单号）。
        *   后端通过消息系统通知前端，前端刷新界面，向用户展示"支付成功"的状态。
    *   **支付失败/取消**:
        *   `wx.requestPayment` API会返回失败或取消的回调，前端向用户展示相应的提示（如"支付失败，请重试"）。
        -   用户可以返回订单页面，重新发起支付。

### 非功能需求
-   **安全性**:
    *   严格遵守微信支付的安全规范。
    *   商户密钥（API Key）必须保存在安全的服务器端，严禁泄露。
    *   所有与支付相关的通信必须使用HTTPS。
    *   后端收到的异步通知必须做严格的签名校验，防止伪造通知。
-   **性能**: 从点击支付到拉起微信支付界面的时间应<3秒。
-   **可靠性**: 异步通知的处理必须可靠，支持重试机制，保证在网络波动等异常情况下，订单状态最终能被正确更新。

## 验收标准

### 功能验收标准
-   **AC1**: 用户在小程序中可以成功调起微信支付并完成付款。
-   **AC2**: 支付成功后，订单状态能被正确更新为"已支付"。
-   **AC3**: 后端能正确处理微信支付的异步通知，并完成签名校验。
-   **AC4**: 如果用户中途取消支付，可以返回订单页并重新支付。
-   **AC5**: 如果支付失败（如余额不足），用户会收到明确的提示。

### 用户体验验收标准
-   **UX1**: 支付流程一气呵成，体验流畅。
-   **UX2**: 支付成功或失败的状态反馈及时、明确。

### 业务目标验收标准
-   **BIZ1**: 微信支付的支付成功率 > 98%。
-   **BIZ2**: 因支付流程问题导致的客户投诉几乎为零。

## 依赖关系

### 技术依赖
-   后端订单系统
-   微信小程序前端框架
-   消息通知系统（用于后端通知前端刷新状态）

### 业务依赖
-   已申请并开通微信支付商户号，并完成相关配置。
-   已定义好平台的订单和支付状态机。

### 外部依赖
-   微信支付API服务的稳定性。
-   微信客户端的稳定性。

## 风险与缓解措施

### 主要风险
1.  **掉单风险**: 用户前端显示支付成功，但后端因未收到异步通知或处理失败，导致订单状态未更新。
    -   **缓解措施**:
        *   建立一个可靠的、支持重试的异步通知接收程序。
        *   建立一个定时的订单状态检查和校对机制。当一个订单长时间处于"待支付"状态，可以主动去微信支付服务器查询其真实状态。
        *   提供人工客服渠道，作为最终的兜底方案。
2.  **资金安全风险**: 商户密钥泄露，导致资金被盗刷。
    -   **缓解措施**:
        *   严格的服务器安全和权限管理。
        *   密钥不写入代码，而是通过安全的方式（如环璄变量、配置中心）注入。
        *   定期更换密钥。

## 成功指标

### 定量指标
-   **支付成功率**: >98%
-   **掉单率**: <0.01%
-   **支付流程平均耗时**: <1分钟

### 定性指标
-   **用户信任度**: 用户对支付环节的安全性、流畅性高度信任。

## 变更日志

| 日期 | 版本 | 描述 |
| :--- | :--- | :---------- |
|      | 1.0  | 初始版本创建，定义微信支付集成功能 |

## 相关链接

- [史诗03: 支付与交易](../epics/epic-03-payment-transaction.md)
- [故事03.2: 多支付方式支持](story-03.2-multiple-payment-methods.md)
- [故事03.3: 退款处理流程](story-03.3-refund-processing.md)
- [故事02.2: 团课快速预约](story-02.2-group-class-booking.md) 