# 用户故事 03.2: 多平台支付方式支持

## 故事信息
- **故事ID**: 03.2
- **故事标题**: 多平台支付方式支持
- **所属史诗**: 史诗03 - 支付与交易
- **优先级**: 中
- **负责团队**: 后端开发团队 + 前端开发团队(Web)

## 故事描述

**作为** 一名使用Web端（电脑浏览器）的用户，或一名国际用户
**我想要** 使用除了微信支付之外的其他支付方式，如支付宝、银行卡或PayPal
**这样我可以** 根据我自己的支付习惯和可用工具，方便地完成付款

## 价值说明

### 核心价值
虽然微信支付在国内移动端占据主导，但一个完整的业务平台需要考虑多场景、多人群的支付需求。支持多种支付方式，特别是PC端常用的支付宝、网银，以及国际通用的PayPal，是平台从单一场景走向多元化、从本土走向国际化的必要基础。

### 业务价值
- **拓展Web端用户**: 为习惯使用电脑进行预订和支付的用户提供便利，完善Web端用户体验闭环。
- **服务国际用户**: 支持PayPal和国际信用卡，是吸引和服务外籍教练、用户的先决条件。
- **提升支付覆盖率**: 满足不同用户的支付偏好，在微信支付不可用或不便的场景下提供备选方案，提升整体支付成功率。
- **增强平台扩展性**: 构建的聚合支付层，能让未来接入新的支付方式变得简单高效。

## 详细需求

### 功能需求
1.  **聚合支付网关**:
    *   后端需要构建一个"聚合支付"层，统一处理对不同支付渠道的调用。
    *   该层负责封装与支付宝、Stripe(用于银行卡)、PayPal等支付渠道API的交互细节。
2.  **支付方式选择**:
    *   在Web端的支付页面，以列表或图标的形式，清晰展示所有可用的支付方式（如：支付宝、银行卡、PayPal）。
    *   根据用户设备、地区或订单货币类型，可以动态地显示或隐藏某些支付方式。
3.  **支付宝支付流程 (PC扫码)**:
    *   用户选择支付宝后，后端调用支付宝API生成一个支付二维码。
    *   前端页面展示该二维码，并提示用户"请使用手机支付宝App扫码支付"。
    *   前端轮询或通过WebSocket监听后端，获取支付状态的变更。
    *   用户扫码支付成功后，后端收到支付宝的异步回调，更新订单状态，并通知前端跳转到成功页。
4.  **银行卡支付流程 (集成Stripe为例)**:
    *   用户选择银行卡支付后，前端展示一个由Stripe.js生成的安全支付表单（包含卡号、有效期、CVC）。
    *   用户信息直接提交到Stripe服务器，Stripe返回一个一次性的支付Token。
    *   前端将该Token和订单信息发送到后端。
    *   后端使用该Token调用Stripe API完成扣款。
    *   后端处理Stripe的异步回调（Webhook），更新订单状态。
5.  **PayPal支付流程**:
    *   用户选择PayPal后，页面跳转到PayPal的官方支付网关。
    -   用户在PayPal网站上登录并完成授权支付。
    *   支付完成后，PayPal将用户重定向回平台指定的URL，并附带支付结果参数。
    -   后端同时也会收到PayPal的异步通知（IPN），在校验后更新订单状态。

### 非功能需求
-   **安全性**:
    *   严格遵守各支付渠道的安全规范，特别是PCI DSS合规（针对银行卡支付）。
    *   敏感的API密钥和证书必须安全存储在服务端。
-   **模块化**: 支付渠道的实现应是"插件式"的，方便未来增加或替换某个支付渠道。
-   **用户体验**: 不同支付方式的流程应尽可能统一和流畅。

## 验收标准

### 功能验收标准
-   **AC1**: Web端用户可以选择并使用支付宝扫码支付，并成功完成订单。
-   **AC2**: Web端用户可以选择并使用银行卡（通过Stripe）支付，并成功完成订单。
-   **AC3**: Web端用户可以选择并使用PayPal支付，并成功完成订单。
-   **AC4**: 所有支付方式在支付成功后，订单状态都能被正确更新。
-   **AC5**: 后端能正确处理来自支付宝、Stripe、PayPal的异步回调通知。

### 用户体验验收标准
-   **UX1**: 支付方式的选择清晰明了。
-   **UX2**: 每种支付流程的引导清晰，用户知道如何操作。
-   **UX3**: 支付成功或失败的跳转和提示及时、准确。

### 业务目标验收标准
-   **BIZ1**: Web端的支付成功率达到95%以上。
-   **BIZ2**: 平台能成功处理来自至少2个国家/地区用户的支付。

## 依赖关系

### 技术依赖
-   后端聚合支付模块/网关
-   与各支付渠道（支付宝、Stripe、PayPal）的API对接
-   前端支付页面UI/UX设计

### 业务依赖
-   已申请并开通支付宝、Stripe、PayPal等平台的商户账户。
-   法务和财务部门已确认支持多币种结算和相关的税务、合规事宜。

### 外部依赖
-   各支付渠道API服务的稳定性。

## 风险与缓解措施

### 主要风险
1.  **跨境支付合规风险**: 不同国家和地区的金融法规不同，可能存在合规风险。
    -   **缓解措施**:
        *   优先使用Stripe、PayPal等大型、成熟的国际支付网关，利用其全球合规能力。
        *   在业务扩展到新国家前，由法务团队进行合规审查。
2.  **技术对接复杂性**: 不同支付渠道的API、参数、流程、安全要求各不相同，对接和维护成本高。
    -   **缓解措施**:
        *   构建一个良好设计的聚合支付层，将差异性封装在内部，对业务层提供统一的接口。
        *   为每个支付渠道编写完整的技术文档和测试用例。
3.  **汇率风险**: 多币种交易中存在汇率波动风险。
    -   **缓解措施**:
        *   使用支付渠道提供的汇率或锁定汇率功能。
        *   在定价策略中考虑一定的汇率波动缓冲。

## 成功指标

### 定量指标
-   **非微信支付订单占比**: >10%
-   **Web端订单支付成功率**: >95%
-   **新支付渠道接入时间**: <2周

### 定性指标
-   **用户反馈**: Web端和国际用户对支付的便利性感到满意。

## 变更日志

| 日期 | 版本 | 描述 |
| :--- | :--- | :---------- |
|      | 1.0  | 初始版本创建，定义多平台支付方式支持 |

## 相关链接

- [史诗03: 支付与交易](../epics/epic-03-payment-transaction.md)
- [故事03.1: 微信支付集成](story-03.1-wechat-payment.md)
- [故事03.3: 退款处理流程](story-03.3-refund-processing.md)
- [故事03.4: 支付安全保障](story-03.4-payment-security.md) 